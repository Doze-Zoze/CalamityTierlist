@page "/"

@using CalamityTierList.Data;
@using System.Text.Json;
@inject HttpClient Http

<PageTitle>Calamity Weapon Tierlist</PageTitle>

<h1 style="margin: 50px" disabled>Calamity Weapon Tierlist</h1>

<div id="TestMainBox" class="divider" style="min-width:100%;overflow-x:auto;">
    <table style="min-width:600px">
        <thead>
            <tr>
                <th style="width: 20%">Weapon</th>
                <th style="width: 0%">Tier</th>
                <th style="width: 30%">Best Times</th>
                @*<th>Average Times</th>*@
                <th style="width: 10%">Short Notes</th>
                <th>Notes</th>
                <th></th>
            </tr>
        </thead>
		<tbody>
            @foreach (var test in Data.aggregateTests)
            {
                <tr>
                    <td>
                        <div style="display:flex;flex-direction:column;justify-content:center;justify-items:center;">
                            @{
                                var currentWeapon = Data.LoadedWeapons.First(x => x.Name == test.ItemName);
                                <img src="@( !string.IsNullOrWhiteSpace(currentWeapon.ImageOverride) ? currentWeapon.ImageOverride : currentWeapon.Vanilla ? $"https://terraria.wiki.gg/images/{test.ItemName.Replace(" ","_")}.png" : $"https://calamitymod.wiki.gg/images/{test.ItemName.Replace(" ","_")}.png")" style="max-width: 48px; margin:auto" />
                                <a style="margin:auto; text-align:center" href="@(!string.IsNullOrWhiteSpace(currentWeapon.WikiOverride) ? currentWeapon.WikiOverride : $"https://{(currentWeapon.Vanilla ? "terraria" : "calamitymod")}.wiki.gg/wiki/{test.ItemName.Replace(" ", "_")}")">@test.ItemName</a>
                            }
                        </div>
                </td>
                    <td>
                        @foreach (var boss in test.Tests)
                        {
                            <div style="margin-bottom: 5px">
                                @boss.tier
                            </div>
                        }
                    </td>
            <td>
                @foreach (var boss in test.BestTimes)
                {
                    <div style="margin-bottom: 5px" title="@boss.note">
                                <b>@boss.name</b>: @boss.timeString @if (boss.died > 0) {
                                <small> (@boss.diedString left)</small>
                            } @if (!string.IsNullOrWhiteSpace(boss.gear))
                            {
                                <small> (@boss.gear)</small>
                            }
                        </div>
                }
				</td>
                    @*<td>
                        @foreach (var boss in test.AverageTimes)
                        {
                            <div style="margin-bottom: 5px">
                                <b>@boss.Key</b>: @Data.FormatTime( boss.Value)
                            </div>
                        }
                    </td>*@

                <td style="max-width:33%">
                        @foreach (var boss in test.Tests) if (!string.IsNullOrWhiteSpace(boss.shortnote))
                            {
                                <div style="margin-bottom: 5px">
                                    <p title="@boss.tester">@boss.notes</p>
                                    <p title="@boss.tester">@boss.shortnote</p>
                                </div>
                            }
                </td>
                    <td style="max-width:33%">
                        @foreach (var boss in test.Tests)
                        {
                            <div style="margin-bottom: 5px">
                                <p title="@boss.tester">@boss.notes</p>
                            </div>
                        }
                    </td>
                <td><NavLink href="TestDetails" @onclick="(a) => {Data.SelectedTest = test;}">See Details</NavLink></td>
         </tr>
    }
    </tbody>
	</table>
</div>

@code {
    public string output
    {
        get
        {
            return JsonSerializer.Serialize(Data.LoadedWeapons, new JsonSerializerOptions { WriteIndented = true, DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull });
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await Data.LoadTestData(Http);
        await Data.LoadWeaponTSV(Http);
    }

}
